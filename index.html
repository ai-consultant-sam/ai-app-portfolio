<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmailCraft AI - 営業メール自動生成</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #64748B;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #E2E8F0;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.5rem;
            color: #3B82F6;
        }

        .logo i {
            font-size: 1.8rem;
        }

        .nav {
            display: flex;
            gap: 2rem;
        }

        .nav a {
            text-decoration: none;
            color: #64748B;
            font-weight: 500;
            transition: color 0.3s ease;
        }

        .nav a:hover {
            color: #3B82F6;
        }

        /* Main Content */
        .main {
            padding: 3rem 0;
        }

        .hero {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.9);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Form Card */
        .form-card {
            background: #FFFFFF;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            margin-bottom: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            position: absolute;
            top: 0.75rem;
            left: 1rem;
            color: #64748B;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
            pointer-events: none;
            background: #FFFFFF;
            padding: 0 0.25rem;
        }

        .form-group input:focus + label,
        .form-group input:not(:placeholder-shown) + label,
        .form-group textarea:focus + label,
        .form-group textarea:not(:placeholder-shown) + label,
        .form-group select:focus + label,
        .form-group select:not([value=""]) + label {
            top: -0.5rem;
            font-size: 0.75rem;
            color: #3B82F6;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            background: #FFFFFF;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        /* Generate Button */
        .generate-btn {
            background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%);
            color: #FFFFFF;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            max-width: 300px;
            margin: 2rem auto 0;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
        }

        .loading.show {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            display: none;
            background: #FFFFFF;
            border-radius: 16px;
            padding: 2.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .results-section.show {
            display: block;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #F8FAFC;
        }

        .results-header h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: #1F2937;
        }

        .results-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3B82F6;
            color: #FFFFFF;
        }

        .btn-primary:hover {
            background: #2563EB;
        }

        .btn-secondary {
            background: #F8FAFC;
            color: #64748B;
            border: 1px solid #E2E8F0;
        }

        .btn-secondary:hover {
            background: #E2E8F0;
        }

        .btn-success {
            background: #10B981;
            color: #FFFFFF;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* Personal Info Section */
        .personal-info-section {
            margin-bottom: 1.5rem;
        }

        .personal-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #E2E8F0;
        }

        .personal-info-header h3 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1F2937;
            margin: 0;
        }

        .personal-info-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Form Section Layout */
        .form-section {
            margin-bottom: 30px;
            display: block;
            width: 100%;
        }

        .form-group {
            display: block;
            width: 100%;
            margin-bottom: 15px;
        }

        /* 強制的に縦1列配置 */
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            max-width: 100%;
            display: block;
        }

        .saved-field {
            background-color: #F8FAFC;
            border-color: #CBD5E1;
        }

        .saved-field:focus {
            border-color: #3B82F6;
            background-color: #FFFFFF;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background-color: #FFFFFF;
            margin: 15% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-family: 'Poppins', sans-serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1F2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748B;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #3B82F6;
        }

        .modal-body {
            margin-bottom: 1.5rem;
            color: #64748B;
            line-height: 1.6;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .email-content {
            background: #F8FAFC;
            border: 1px solid #E2E8F0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            white-space: pre-wrap;
            line-height: 1.7;
            font-size: 1rem;
        }

        /* Error Message */
        .error-message {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Success Message */
        .success-message {
            background: #F0FDF4;
            border: 1px solid #BBF7D0;
            color: #16A34A;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .nav {
                gap: 1rem;
            }

            .hero h1 {
                font-size: 2rem;
            }

            .form-card {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .form-section {
                margin-bottom: 20px;
            }
            
            .form-group {
                margin-bottom: 12px;
            }

            .results-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .results-actions {
                width: 100%;
                justify-content: space-between;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 15px;
            }

            .form-card {
                padding: 1rem;
            }

            .generate-btn {
                padding: 0.875rem 1.5rem;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-envelope-open-text"></i>
                    EmailCraft AI
                </div>
                <nav class="nav">
                    <a href="#home">ホーム</a>
                    <a href="#features">機能</a>
                    <a href="#contact">お問い合わせ</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Hero Section -->
            <div class="hero">
                <h1>営業メールをAIで自動生成</h1>
                <p>顧客情報と商品・サービス情報を入力するだけで、<br>プロフェッショナルな営業メールを瞬時に生成します。</p>
            </div>

            <!-- Error/Success Messages -->
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>

            <!-- Form Card -->
            <div class="form-card">
                <form id="emailForm">
                    <div class="form-grid">
                                    <!-- Personal Information -->
            <div class="personal-info-section">
                <div class="personal-info-header">
                    <h3>本人情報</h3>
                    <div class="personal-info-actions">
                        <button type="button" class="btn btn-primary btn-sm" id="savePersonalInfo" style="display: none;">
                            <i class="fas fa-save"></i>
                            保存
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="editPersonalInfo" style="display: none;">
                            <i class="fas fa-edit"></i>
                            編集
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="deletePersonalInfo" style="display: none;">
                            <i class="fas fa-trash"></i>
                            削除
                        </button>
                    </div>
                </div>
                <div class="form-section">
                    <div class="form-group">
                        <input type="text" id="personalCompany" placeholder=" " required>
                        <label for="personalCompany">本人会社名</label>
                    </div>
                    
                    <div class="form-group">
                        <input type="text" id="personalDepartment" placeholder=" " required>
                        <label for="personalDepartment">本人部署名</label>
                    </div>

                    <div class="form-group">
                        <input type="text" id="personalName" placeholder=" " required>
                        <label for="personalName">本人氏名</label>
                    </div>

                    <div class="form-group">
                        <input type="text" id="personalPosition" placeholder=" " required>
                        <label for="personalPosition">本人役職</label>
                    </div>

                    <div class="form-group">
                        <input type="tel" id="personalPhone" placeholder=" " required>
                        <label for="personalPhone">本人電話番号</label>
                    </div>

                    <div class="form-group">
                        <input type="email" id="personalEmail" placeholder=" " required>
                        <label for="personalEmail">本人メールアドレス</label>
                    </div>
                </div>
            </div>

                        <!-- Customer Information -->
                        <div class="form-section">
                            <div class="form-group">
                                <input type="text" id="companyName" placeholder=" " required>
                                <label for="companyName">顧客会社名</label>
                            </div>
                            
                            <div class="form-group">
                                <input type="text" id="contactPerson" placeholder=" " required>
                                <label for="contactPerson">担当者名</label>
                            </div>

                            <div class="form-group">
                                <select id="industry" required>
                                    <option value="">業界を選択</option>
                                    <option value="IT・ソフトウェア">IT・ソフトウェア</option>
                                    <option value="製造業">製造業</option>
                                    <option value="金融・保険">金融・保険</option>
                                    <option value="医療・ヘルスケア">医療・ヘルスケア</option>
                                    <option value="小売・流通">小売・流通</option>
                                    <option value="建設・不動産">建設・不動産</option>
                                    <option value="教育">教育</option>
                                    <option value="その他">その他</option>
                                </select>
                                <label for="industry">業界</label>
                            </div>

                            <div class="form-group">
                                <select id="department" required>
                                    <option value="">業界を先に選択してください</option>
                                </select>
                                <label for="department">部署</label>
                            </div>
                        </div>

                        <!-- Product/Service Information -->
                        <div class="form-section">
                            <div class="form-group full-width">
                                <textarea id="productInfo" placeholder=" " required></textarea>
                                <label for="productInfo">商品・サービス情報（特徴、メリット、価格など）</label>
                            </div>
                        </div>

                        <!-- Settings -->
                        <div class="form-section">
                            <div class="form-group">
                                <select id="emailPurpose" required>
                                    <option value="">メール目的を選択</option>
                                    <option value="初回アプローチ">初回アプローチ</option>
                                    <option value="フォローアップ">フォローアップ</option>
                                    <option value="提案">提案</option>
                                    <option value="その他">その他</option>
                                </select>
                                <label for="emailPurpose">メール目的</label>
                            </div>

                            <div class="form-group">
                                <select id="tone" required>
                                    <option value="">トーンを選択</option>
                                    <option value="フォーマル">フォーマル</option>
                                    <option value="フレンドリー">フレンドリー</option>
                                    <option value="カジュアル">カジュアル</option>
                                </select>
                                <label for="tone">トーン</label>
                            </div>

                            <div class="form-group">
                                <select id="length" required>
                                    <option value="">文字数を選択</option>
                                    <option value="短文">短文（150文字程度）</option>
                                    <option value="標準">標準（300文字程度）</option>
                                    <option value="詳細">詳細（500文字程度）</option>
                                </select>
                                <label for="length">文字数</label>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="generate-btn" id="generateBtn">
                        <i class="fas fa-magic"></i>
                        <span>AIでメール生成</span>
                        <i class="fas fa-spinner loading" id="loadingSpinner"></i>
                    </button>
                </form>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection">
                <div class="results-header">
                    <h3>生成されたメール</h3>
                    <div class="results-actions">
                        <button class="btn btn-success" id="copyBtn">
                            <i class="fas fa-copy"></i>
                            コピー
                        </button>
                        <button class="btn btn-secondary" id="regenerateBtn">
                            <i class="fas fa-redo"></i>
                            再生成
                        </button>
                    </div>
                </div>
                <div class="email-content" id="emailContent"></div>
            </div>

            <!-- Save Confirmation Modal -->
            <div class="modal" id="saveModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">本人情報の保存</h3>
                        <button class="modal-close" id="closeSaveModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        入力された本人情報を保存しますか？<br>
                        次回以降、自動的に入力されます。
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelSave">キャンセル</button>
                        <button class="btn btn-primary" id="confirmSave">保存する</button>
                    </div>
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="modal" id="deleteModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">保存情報の削除</h3>
                        <button class="modal-close" id="closeDeleteModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        保存された本人情報を削除しますか？<br>
                        削除後は再度入力が必要になります。
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" id="cancelDelete">キャンセル</button>
                        <button class="btn btn-success" id="confirmDelete">削除する</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        class EmailCraftAI {
            constructor() {
                this.apiKey = null;
                this.form = document.getElementById('emailForm');
                this.generateBtn = document.getElementById('generateBtn');
                this.loadingSpinner = document.getElementById('loadingSpinner');
                this.resultsSection = document.getElementById('resultsSection');
                this.emailContent = document.getElementById('emailContent');
                this.copyBtn = document.getElementById('copyBtn');
                this.regenerateBtn = document.getElementById('regenerateBtn');
                this.errorMessage = document.getElementById('errorMessage');
                this.successMessage = document.getElementById('successMessage');
                
                // Personal info elements
                this.savePersonalInfo = document.getElementById('savePersonalInfo');
                this.editPersonalInfo = document.getElementById('editPersonalInfo');
                this.deletePersonalInfo = document.getElementById('deletePersonalInfo');
                
                // Modal elements
                this.saveModal = document.getElementById('saveModal');
                this.deleteModal = document.getElementById('deleteModal');
                this.closeSaveModal = document.getElementById('closeSaveModal');
                this.closeDeleteModal = document.getElementById('closeDeleteModal');
                this.confirmSave = document.getElementById('confirmSave');
                this.cancelSave = document.getElementById('cancelSave');
                this.confirmDelete = document.getElementById('confirmDelete');
                this.cancelDelete = document.getElementById('cancelDelete');

                this.initializeEventListeners();
                this.loadSavedPersonalInfo();
            }

            initializeEventListeners() {
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                this.copyBtn.addEventListener('click', () => this.copyToClipboard());
                this.regenerateBtn.addEventListener('click', () => this.handleSubmit());
                
                // 業界選択時の部署選択肢更新
                document.getElementById('industry').addEventListener('change', (e) => {
                    this.updateDepartmentOptions(e.target.value);
                });

                // Personal info actions
                this.savePersonalInfo.addEventListener('click', () => this.savePersonalInfoHandler());
                this.editPersonalInfo.addEventListener('click', () => this.editPersonalInfoHandler());
                this.deletePersonalInfo.addEventListener('click', () => this.showDeleteModal());
                
                // Modal events
                this.closeSaveModal.addEventListener('click', () => this.hideModal(this.saveModal));
                this.closeDeleteModal.addEventListener('click', () => this.hideModal(this.deleteModal));
                this.cancelSave.addEventListener('click', () => this.hideModal(this.saveModal));
                this.cancelDelete.addEventListener('click', () => this.hideModal(this.deleteModal));
                this.confirmSave.addEventListener('click', () => this.savePersonalInfo());
                this.confirmDelete.addEventListener('click', () => this.deletePersonalInfoHandler());
                
                // Close modal when clicking outside
                this.saveModal.addEventListener('click', (e) => {
                    if (e.target === this.saveModal) this.hideModal(this.saveModal);
                });
                this.deleteModal.addEventListener('click', (e) => {
                    if (e.target === this.deleteModal) this.hideModal(this.deleteModal);
                });
            }

            showMessage(element, message, isError = false) {
                element.textContent = message;
                element.classList.add('show');
                
                if (isError) {
                    this.successMessage.classList.remove('show');
                } else {
                    this.errorMessage.classList.remove('show');
                }

                setTimeout(() => {
                    element.classList.remove('show');
                }, 5000);
            }

            async getApiKey() {
                if (this.apiKey) return this.apiKey;
                
                this.apiKey = window.prompt('OpenAI APIキーを入力してください:');
                if (!this.apiKey) {
                    throw new Error('APIキーが必要です');
                }
                return this.apiKey;
            }

            getFormData() {
                return {
                    personalCompany: document.getElementById('personalCompany').value,
                    personalDepartment: document.getElementById('personalDepartment').value,
                    personalName: document.getElementById('personalName').value,
                    personalPosition: document.getElementById('personalPosition').value,
                    personalPhone: document.getElementById('personalPhone').value,
                    personalEmail: document.getElementById('personalEmail').value,
                    companyName: document.getElementById('companyName').value,
                    industry: document.getElementById('industry').value,
                    department: document.getElementById('department').value,
                    contactPerson: document.getElementById('contactPerson').value,
                    productInfo: document.getElementById('productInfo').value,
                    emailPurpose: document.getElementById('emailPurpose').value,
                    tone: document.getElementById('tone').value,
                    length: document.getElementById('length').value
                };
            }

            createPrompt(formData) {
                const lengthMap = {
                    '短文': '150文字程度',
                    '標準': '300文字程度', 
                    '詳細': '500文字程度'
                };

                return `以下の条件で営業メールを作成してください：

【本人情報】
- 会社名: ${formData.personalCompany}
- 部署名: ${formData.personalDepartment}
- 氏名: ${formData.personalName}
- 役職: ${formData.personalPosition}
- 電話番号: ${formData.personalPhone}
- メールアドレス: ${formData.personalEmail}

【顧客情報】
- 会社名: ${formData.companyName}
- 業界: ${formData.industry}
- 部署: ${formData.department}
- 担当者名: ${formData.contactPerson}

【商品・サービス情報】
${formData.productInfo}

【メール要件】
- 目的: ${formData.emailPurpose}
- トーン: ${formData.tone}
- 文字数: ${lengthMap[formData.length]}

【部署別アプローチ】
${this.getDepartmentSpecificPrompt(formData.industry, formData.department)}

以下の形式で作成してください：
1. 件名（Subject）
2. 本文（日本語、敬語を使用）
3. 本人署名（以下の形式で作成）：
   ──────────────────────
   ${formData.personalName}
   ${formData.personalPosition}
   ${formData.personalCompany}
   ${formData.personalDepartment}
   
   TEL: ${formData.personalPhone}
   Email: ${formData.personalEmail}
   ──────────────────────

営業メールとして効果的で、相手に響く内容にしてください。`;
            }

            async generateEmail(prompt) {
                const apiKey = await this.getApiKey();
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {
                                role: 'system',
                                content: 'あなたは営業メール作成の専門家です。顧客のニーズを理解し、効果的な営業メールを作成してください。'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        max_tokens: 1000,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`API エラー: ${error.error?.message || '不明なエラー'}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            }

            async handleSubmit(e) {
                if (e) e.preventDefault();

                try {
                    // フォームバリデーション
                    const formData = this.getFormData();
                    for (const [key, value] of Object.entries(formData)) {
                        if (!value) {
                            throw new Error('すべての項目を入力してください');
                        }
                    }

                    // メールアドレスの形式チェック
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(formData.personalEmail)) {
                        throw new Error('正しいメールアドレスの形式で入力してください');
                    }

                    // 電話番号の形式チェック（基本的な形式）
                    const phoneRegex = /^[\d\-\(\)\s]+$/;
                    if (!phoneRegex.test(formData.personalPhone)) {
                        throw new Error('正しい電話番号の形式で入力してください');
                    }

                    // UI状態更新
                    this.generateBtn.disabled = true;
                    this.loadingSpinner.classList.add('show');
                    this.resultsSection.classList.remove('show');
                    this.errorMessage.classList.remove('show');

                    // メール生成
                    const prompt = this.createPrompt(formData);
                    const emailText = await this.generateEmail(prompt);

                    // 結果表示
                    this.emailContent.textContent = emailText;
                    this.resultsSection.classList.add('show');
                    this.showMessage(this.successMessage, 'メールが正常に生成されました！');
                    
                    // 本人情報の保存確認
                    this.checkForPersonalInfoSave();

                } catch (error) {
                    console.error('Error:', error);
                    this.showMessage(this.errorMessage, error.message, true);
                } finally {
                    this.generateBtn.disabled = false;
                    this.loadingSpinner.classList.remove('show');
                }
            }

            async copyToClipboard() {
                try {
                    await navigator.clipboard.writeText(this.emailContent.textContent);
                    this.showMessage(this.successMessage, 'メールをクリップボードにコピーしました！');
                } catch (error) {
                    this.showMessage(this.errorMessage, 'コピーに失敗しました', true);
                }
            }

            // 部署選択肢の定義
            getDepartmentOptions(industry) {
                const departmentMap = {
                    '製造業': [
                        '製造・生産部門',
                        '営業・マーケティング部門',
                        '経理・財務部門',
                        '人事・総務部門',
                        '品質管理部門',
                        '研究開発部門'
                    ],
                    'IT・ソフトウェア': [
                        '開発・エンジニア部門',
                        '営業・マーケティング部門',
                        '人事・採用部門',
                        '経理・管理部門',
                        'プロダクト企画部門'
                    ],
                    '小売・流通': [
                        '店舗運営部門',
                        '営業・マーケティング部門',
                        '人事・総務部門',
                        '経理・財務部門',
                        '商品企画部門'
                    ],
                    '医療・ヘルスケア': [
                        '医療・診療部門',
                        '事務・受付部門',
                        '経営・管理部門',
                        '看護部門'
                    ],
                    '金融・保険': [
                        '営業・渉外部門',
                        '審査・リスク管理部門',
                        '経理・財務部門',
                        '人事・総務部門',
                        'システム部門'
                    ],
                    '建設・不動産': [
                        '営業・企画部門',
                        '設計・技術部門',
                        '施工管理部門',
                        '経理・管理部門',
                        '人事・総務部門'
                    ],
                    '教育': [
                        '教務部門',
                        '営業・マーケティング部門',
                        '人事・採用部門',
                        '経理・管理部門',
                        '企画・開発部門'
                    ]
                };
                
                return departmentMap[industry] || ['その他'];
            }

            // 部署選択肢の更新
            updateDepartmentOptions(industry) {
                const departmentSelect = document.getElementById('department');
                const options = this.getDepartmentOptions(industry);
                
                // 既存のオプションをクリア
                departmentSelect.innerHTML = '';
                
                // デフォルトオプションを追加
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = industry ? '部署を選択' : '業界を先に選択してください';
                departmentSelect.appendChild(defaultOption);
                
                // 部署オプションを追加
                options.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept;
                    option.textContent = dept;
                    departmentSelect.appendChild(option);
                });
            }

            // 部署別アプローチのプロンプト生成
            getDepartmentSpecificPrompt(industry, department) {
                const departmentPrompts = {
                    '製造業': {
                        '製造・生産部門': '製造効率の向上、品質管理の改善、コスト削減、設備投資の最適化について言及してください。',
                        '営業・マーケティング部門': '売上向上、顧客獲得、市場拡大、競合分析について言及してください。',
                        '経理・財務部門': 'コスト管理、収益性向上、財務効率化、予算最適化について言及してください。',
                        '人事・総務部門': '人材育成、組織強化、業務効率化、コンプライアンスについて言及してください。',
                        '品質管理部門': '品質向上、リスク管理、規格準拠、顧客満足度向上について言及してください。',
                        '研究開発部門': '技術革新、新製品開発、特許戦略、競合優位性について言及してください。'
                    },
                    'IT・ソフトウェア': {
                        '開発・エンジニア部門': '開発効率向上、技術革新、システム安定性、スケーラビリティについて言及してください。',
                        '営業・マーケティング部門': '売上向上、顧客獲得、市場拡大、競合分析について言及してください。',
                        '人事・採用部門': '人材採用、スキル開発、組織文化、エンゲージメント向上について言及してください。',
                        '経理・管理部門': 'コスト管理、収益性向上、財務効率化、予算最適化について言及してください。',
                        'プロダクト企画部門': 'ユーザー体験向上、プロダクト戦略、市場ニーズ対応、競合優位性について言及してください。'
                    },
                    '小売・流通': {
                        '店舗運営部門': '店舗効率化、顧客満足度向上、在庫管理最適化、売上向上について言及してください。',
                        '営業・マーケティング部門': '売上向上、顧客獲得、市場拡大、競合分析について言及してください。',
                        '人事・総務部門': '人材育成、組織強化、業務効率化、コンプライアンスについて言及してください。',
                        '経理・財務部門': 'コスト管理、収益性向上、財務効率化、予算最適化について言及してください。',
                        '商品企画部門': '商品戦略、顧客ニーズ対応、競合優位性、売上向上について言及してください。'
                    },
                    '医療・ヘルスケア': {
                        '医療・診療部門': '医療品質向上、患者満足度向上、診療効率化、医療安全について言及してください。',
                        '事務・受付部門': '業務効率化、患者対応向上、システム最適化、コスト削減について言及してください。',
                        '経営・管理部門': '収益性向上、運営効率化、リスク管理、組織強化について言及してください。',
                        '看護部門': '看護品質向上、患者ケア向上、業務効率化、安全確保について言及してください。'
                    },
                    '金融・保険': {
                        '営業・渉外部門': '売上向上、顧客獲得、リスク管理、競合優位性について言及してください。',
                        '審査・リスク管理部門': 'リスク管理強化、審査精度向上、コンプライアンス確保、損失削減について言及してください。',
                        '経理・財務部門': 'コスト管理、収益性向上、財務効率化、予算最適化について言及してください。',
                        '人事・総務部門': '人材育成、組織強化、業務効率化、コンプライアンスについて言及してください。',
                        'システム部門': 'システム安定性、セキュリティ強化、業務効率化、コスト削減について言及してください。'
                    }
                };

                const industryPrompts = departmentPrompts[industry];
                if (industryPrompts && industryPrompts[department]) {
                    return industryPrompts[department];
                }
                
                // デフォルトのアプローチ
                return '業務効率化、コスト削減、収益性向上、競合優位性について言及してください。';
            }

            // Personal Info Storage Methods
            loadSavedPersonalInfo() {
                try {
                    const savedData = localStorage.getItem('emailcraft_personal_info');
                    if (savedData) {
                        const personalInfo = JSON.parse(savedData);
                        this.fillPersonalInfoFields(personalInfo);
                        this.showEditDeleteButtons();
                        this.markFieldsAsSaved();
                    } else {
                        this.showSaveButton();
                    }
                } catch (error) {
                    console.error('Error loading saved personal info:', error);
                    this.showSaveButton();
                }
            }

            fillPersonalInfoFields(data) {
                document.getElementById('personalCompany').value = data.company || '';
                document.getElementById('personalDepartment').value = data.department || '';
                document.getElementById('personalName').value = data.name || '';
                document.getElementById('personalPosition').value = data.position || '';
                document.getElementById('personalPhone').value = data.phone || '';
                document.getElementById('personalEmail').value = data.email || '';
            }

            markFieldsAsSaved() {
                const fields = ['personalCompany', 'personalDepartment', 'personalName', 'personalPosition', 'personalPhone', 'personalEmail'];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    field.classList.add('saved-field');
                });
            }

            showSaveButton() {
                this.savePersonalInfo.style.display = 'inline-flex';
                this.editPersonalInfo.style.display = 'none';
                this.deletePersonalInfo.style.display = 'none';
            }

            showEditDeleteButtons() {
                this.savePersonalInfo.style.display = 'none';
                this.editPersonalInfo.style.display = 'inline-flex';
                this.deletePersonalInfo.style.display = 'inline-flex';
            }

            hideAllButtons() {
                this.savePersonalInfo.style.display = 'none';
                this.editPersonalInfo.style.display = 'none';
                this.deletePersonalInfo.style.display = 'none';
            }

            savePersonalInfoHandler() {
                const personalData = {
                    company: document.getElementById('personalCompany').value,
                    department: document.getElementById('personalDepartment').value,
                    name: document.getElementById('personalName').value,
                    position: document.getElementById('personalPosition').value,
                    phone: document.getElementById('personalPhone').value,
                    email: document.getElementById('personalEmail').value
                };

                // バリデーション
                for (const [key, value] of Object.entries(personalData)) {
                    if (!value) {
                        this.showMessage(this.errorMessage, 'すべての本人情報を入力してください', true);
                        return;
                    }
                }

                try {
                    localStorage.setItem('emailcraft_personal_info', JSON.stringify(personalData));
                    this.markFieldsAsSaved();
                    this.showEditDeleteButtons();
                    this.showMessage(this.successMessage, '本人情報を保存しました！');
                } catch (error) {
                    console.error('Error saving personal info:', error);
                    this.showMessage(this.errorMessage, '保存に失敗しました', true);
                }
            }

            editPersonalInfoHandler() {
                const fields = ['personalCompany', 'personalDepartment', 'personalName', 'personalPosition', 'personalPhone', 'personalEmail'];
                fields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    field.classList.remove('saved-field');
                    field.readOnly = false;
                });
                this.showSaveButton();
            }

            showSaveModal() {
                this.saveModal.style.display = 'block';
            }

            showDeleteModal() {
                this.deleteModal.style.display = 'block';
            }

            hideModal(modal) {
                modal.style.display = 'none';
            }

            deletePersonalInfoHandler() {
                try {
                    localStorage.removeItem('emailcraft_personal_info');
                    const fields = ['personalCompany', 'personalDepartment', 'personalName', 'personalPosition', 'personalPhone', 'personalEmail'];
                    fields.forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        field.classList.remove('saved-field');
                        field.value = '';
                        field.readOnly = false;
                    });
                    this.showSaveButton();
                    this.hideModal(this.deleteModal);
                    this.showMessage(this.successMessage, '保存された情報を削除しました');
                } catch (error) {
                    console.error('Error deleting personal info:', error);
                    this.showMessage(this.errorMessage, '削除に失敗しました', true);
                }
            }

            // Check if personal info should be saved after successful email generation
            checkForPersonalInfoSave() {
                const hasPersonalInfo = document.getElementById('personalCompany').value &&
                                      document.getElementById('personalDepartment').value &&
                                      document.getElementById('personalName').value &&
                                      document.getElementById('personalPosition').value &&
                                      document.getElementById('personalPhone').value &&
                                      document.getElementById('personalEmail').value;

                const isAlreadySaved = localStorage.getItem('emailcraft_personal_info');

                if (hasPersonalInfo && !isAlreadySaved) {
                    this.showSaveModal();
                }
            }
        }

        // アプリケーション初期化
        document.addEventListener('DOMContentLoaded', () => {
            new EmailCraftAI();
        });
    </script>
</body>
</html>
